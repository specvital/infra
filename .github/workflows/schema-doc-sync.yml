name: Sync Schema Docs

on:
  push:
    branches: [main]
    paths:
      - "db/schema/schema.hcl"
  workflow_dispatch:

jobs:
  sync-schema-doc:
    name: Generate and Sync Schema Docs
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout infra
        uses: actions/checkout@v4

      - name: Setup Atlas
        uses: ariga/setup-atlas@v0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install tbls
        run: go install github.com/k1LoW/tbls@v1.92.3

      - name: Apply migrations
        run: |
          atlas migrate apply \
            --url "postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable" \
            --dir "file://db/schema/migrations"

      - name: Generate schema docs
        run: |
          export DATABASE_URL="postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable"
          cd db && tbls doc --force
          echo "Generated $(find docs/schema -name '*.md' | wc -l) doc files"

      - name: Checkout specvital.github.io
        uses: actions/checkout@v4
        with:
          repository: specvital/specvital.github.io
          token: ${{ secrets.PAT_TOKEN }}
          path: github-io

      - name: Copy schema docs
        run: |
          rm -rf github-io/docs/schema
          cp -r db/docs/schema github-io/docs/

      - name: Setup Node 22
        uses: actions/setup-node@v6
        with:
          node-version: "22.18.0"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: extractions/setup-just@v3

      - name: Install dependencies
        run: just deps-root

      - name: Lint docs
        run: just lint config

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.PAT_TOKEN }}
          path: github-io
          branch: docs/update-schema-docs
          title: "docs: update schema documentation"
          body: |
            Automated update of schema documentation from [specvital-infra](https://github.com/specvital/infra).

            Generated by [tbls](https://github.com/k1LoW/tbls) - includes:
            - Table details with columns, types, constraints
            - Indexes and unique keys
            - ER diagram (Mermaid)

            Triggered by: ${{ github.event.head_commit.message }}
          commit-message: "docs: update schema documentation"
          delete-branch: true
